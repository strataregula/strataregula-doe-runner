name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[test,dev]"
    
    - name: Code quality checks with ruff
      run: |
        echo "ğŸ” Running code quality checks..."
        
        echo "ğŸ“‹ Checking code style and quality..."
        ruff check src/ tests/ || {
          echo ""
          echo "âŒ CODE QUALITY ISSUES FOUND"
          echo "=============================="
          echo "ğŸ”§ Fix automatically with:"
          echo "   ruff check --fix src/ tests/"
          echo ""
          echo "ğŸ“‹ Or fix manually following the suggestions above"
          exit 1
        }
        
        echo "ğŸ“ Checking code formatting..."
        ruff format --check src/ tests/ || {
          echo ""
          echo "âŒ CODE FORMATTING ISSUES FOUND"
          echo "================================="
          echo "ğŸ”§ Fix automatically with:"
          echo "   ruff format src/ tests/"
          echo ""
          exit 1
        }
        
        echo "âœ… Code quality checks passed!"
    
    - name: Type checking with mypy
      run: |
        echo "ğŸ” Running type checking..."
        mypy src/strataregula_doe_runner/ || {
          echo ""
          echo "âŒ TYPE CHECKING ERRORS FOUND"
          echo "==============================="
          echo "ğŸ”§ Common fixes:"
          echo "   â€¢ Add type hints to function parameters"
          echo "   â€¢ Import missing type annotations"
          echo "   â€¢ Fix type mismatches shown above"
          echo ""
          echo "ğŸ’¡ See mypy documentation: https://mypy.readthedocs.io/"
          exit 1
        }
        echo "âœ… Type checking passed!"
    
    - name: Security scanning with bandit
      run: |
        echo "ğŸ›¡ï¸ Running security analysis..."
        bandit -r src/strataregula_doe_runner/ || {
          echo ""
          echo "âŒ SECURITY ISSUES DETECTED"
          echo "============================"
          echo "âš ï¸ Potential security vulnerabilities found above"
          echo ""
          echo "ğŸ”§ Common fixes:"
          echo "   â€¢ Avoid hardcoded secrets"
          echo "   â€¢ Use secure subprocess calls"
          echo "   â€¢ Validate user inputs"
          echo ""
          echo "ğŸ’¡ See bandit docs: https://bandit.readthedocs.io/"
          exit 1
        }
        echo "âœ… Security scan completed successfully!"
    
    - name: Test with pytest and coverage check
      run: |
        echo "ğŸ§ª Running tests with coverage analysis..."
        
        # Run tests with coverage
        pytest tests/ \
          --cov=strataregula_doe_runner \
          --cov-report=xml \
          --cov-report=term-missing \
          --cov-report=html:htmlcov \
          --cov-fail-under=77 \
          -v || {
          
          echo ""
          echo "âŒ COVERAGE FAILURE DETECTED"
          echo "================================"
          echo "ğŸ“Š Coverage fell below required threshold!"
          echo ""
          echo "ğŸ¯ Required: 77%"
          echo "ğŸ“ˆ Achieve target by adding tests to:"
          echo "   â€¢ CLI module (currently ~35%)"
          echo "   â€¢ Validator module (currently ~61%)"  
          echo "   â€¢ Shell adapter (currently ~67%)"
          echo ""
          echo "ğŸ’¡ Quick fixes:"
          echo "   1. Add CLI integration tests"
          echo "   2. Test error handling paths"
          echo "   3. Test edge cases in validation"
          echo ""
          echo "ğŸ“‹ See HTML coverage report in htmlcov/ for details"
          exit 1
        }
        
        echo "âœ… All tests passed with sufficient coverage!"
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: true
        verbose: true

  integration:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install package
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[test]"
    
    - name: Test CLI installation
      run: |
        srd --help
        srd --version
    
    - name: Test plugin discovery
      run: |
        python -c "
        import pkg_resources
        eps = list(pkg_resources.iter_entry_points('strataregula.plugins'))
        print(f'Found {len(eps)} plugins')
        for ep in eps:
            if ep.name == 'doe_runner':
                plugin = ep.load()()
                info = plugin.get_info()
                print(f'Plugin: {info[\"name\"]} v{info[\"version\"]}')
        "
    
    - name: End-to-end test
      run: |
        # Create test cases
        cat > test_cases.csv << EOF
        case_id,backend,cmd_template,timeout_s,seed,retries,resource_group,expected_p95,threshold_p95
        test-01,dummy,"echo 'dummy test'",10,42,2,default,0.05,0.06
        test-02,shell,"echo 'p95=0.08 p99=0.12 throughput_rps=500'",10,123,1,default,0.08,0.10
        EOF
        
        # Execute via CLI
        srd run --cases test_cases.csv --out metrics.csv --dry-run
        
        # Execute via plugin
        python -c "
        from strataregula_doe_runner.plugin import DOERunnerPlugin
        plugin = DOERunnerPlugin()
        result = plugin.execute_cases(
            cases_path='test_cases.csv',
            metrics_path='metrics_test.csv',
            max_workers=1,
            verbose=True
        )
        print(f'Execution result: {result[\"status\"]}')
        print(f'Exit code: {result[\"exit_code\"]}')
        assert result['status'] == 'success', f'Failed: {result}'
        "
        
        # Verify metrics output
        if [ -f "metrics_test.csv" ]; then
          echo "âœ… Metrics file generated"
          head -3 metrics_test.csv
        else
          echo "âŒ Metrics file not found"
          exit 1
        fi

  build:
    runs-on: ubuntu-latest
    needs: [test, integration]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Build package
      run: |
        python -m build
    
    - name: Check package
      run: |
        python -m twine check dist/*
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dist-packages
        path: dist/